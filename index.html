<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Lyra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .typing-indicator span { animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.2s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.1s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="bg-gray-50">
    <main class="min-h-screen w-full flex flex-col md:flex-row items-center justify-center p-4 gap-8">
        <div class="w-full md:w-1/3 flex justify-center items-center">
            <img src="avatar_lyra.png" alt="Avatar de Lyra" class="rounded-full w-48 h-48 md:w-64 md:h-64 object-cover shadow-lg"/>
        </div>
        <div class="w-full max-w-xl">
            <div class="bg-white rounded-lg shadow-lg">
                <div class="p-4 text-center text-xl font-bold border-b">ðŸ¤– Asistente Empresarial Lyra</div>
                <div id="chat-window" class="h-96 overflow-y-auto p-4"></div>
                <div class="p-4 border-t flex gap-2">
                    <input id="user-input" type="text" placeholder="Escribe tu pregunta..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" />
                    <button id="send-button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium bg-blue-500 text-white hover:bg-blue-600 h-10 px-4 py-2">Enviar</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        let lastQuestion = ""; // Variable para guardar la Ãºltima pregunta que no supo

        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `mb-2 text-sm flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('span');
            bubble.className = `inline-block px-3 py-1 rounded-lg shadow ${sender === 'user' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700'}`;
            bubble.innerHTML = text; // Usamos innerHTML para poder aÃ±adir saltos de lÃ­nea
            messageElement.appendChild(bubble);
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.id = 'typing-indicator';
            typingElement.className = 'mb-2 text-sm flex justify-start';
            typingElement.innerHTML = `<span class="typing-indicator inline-block px-3 py-1 rounded-lg shadow bg-white text-gray-700"><span class="w-2 h-2 bg-gray-400 rounded-full inline-block"></span><span class="w-2 h-2 bg-gray-400 rounded-full inline-block"></span><span class="w-2 h-2 bg-gray-400 rounded-full inline-block"></span></span>`;
            chatWindow.appendChild(typingElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function learnAnswer(question, answer) {
            try {
                const response = await fetch("https://lyra-backend-vercel.vercel.app/api/learn", { // Llama al nuevo endpoint
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question, answer }),
                });
                const data = await response.json();
                addMessage('lyra', data.message || 'Â¡Gracias! Lo recordarÃ©.');
            } catch (error) {
                console.error("Error al aprender:", error);
                addMessage('lyra', 'Tuve un problema al intentar guardar lo que me enseÃ±aste.');
            }
        }

        async function handleSend() {
            const question = userInput.value.trim();
            if (!question) return;

            addMessage('user', question);
            userInput.value = '';
            showTypingIndicator();
            sendButton.disabled = true;

            if (lastQuestion) {
                await learnAnswer(lastQuestion, question);
                lastQuestion = "";
                hideTypingIndicator();
                sendButton.disabled = false;
                return;
            }

            try {
                const response = await fetch("https://lyra-backend-vercel.vercel.app/api/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question }),
                });

                if (!response.ok) throw new Error("Error en la API");
                const data = await response.json();
                
                hideTypingIndicator();

                if (data.answer === "NO_SE") {
                    addMessage('lyra', 'Lo siento, no sÃ© la respuesta a eso.<br>Â¿PodrÃ­as enseÃ±arme? Escribe la respuesta correcta.');
                    lastQuestion = question;
                } else {
                    addMessage('lyra', data.answer);
                }

            } catch (error) {
                console.error("Error al llamar a la API:", error);
                hideTypingIndicator();
                addMessage('lyra', "Lo siento, no pude conectarme con mi cerebro.");
            } finally {
                sendButton.disabled = false;
            }
        }

        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') handleSend(); });

        addMessage('lyra', 'Hola, soy Lyra. Â¿CÃ³mo te ayudo hoy?');
    </script>
</body>
</html>
